<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker - Toy Story Theme</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Prompt:wght@300;400;600;800&display=swap" rel="stylesheet">

    <!-- Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Prompt"', 'sans-serif'],
                        cartoon: ['"Fredoka"', '"Prompt"', 'sans-serif'],
                    },
                    colors: {
                        'toy-blue': '#1F4788',  
                        'toy-yellow': '#F9D615', 
                        'toy-red': '#E81F26',    
                        'buzz-green': '#87D336', 
                        'buzz-purple': '#714798', 
                        'sky-blue': '#87CEEB',
                    }
                }
            }
        }
    </script>

    <style>
        /* ‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤ */
        html, body {
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
            position: relative;
        }

        body {
            background-color: #87CEEB;
            color: #1F2937;
            font-family: 'Prompt', sans-serif;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='600' viewBox='0 0 600 600'%3E%3Cg fill='%23FFFFFF' opacity='0.4'%3E%3Cpath d='M49.3,55.8c-0.2-1.3-0.4-2.6-0.4-3.9c0-11.8,9.6-21.4,21.4-21.4c6.6,0,12.5,3,16.4,7.7c4.6-9.1,14.1-15.3,25-15.3c15.3,0,27.8,12.5,27.8,27.8c0,1.3-0.1,2.5-0.3,3.8c7.4,2.9,12.6,10.1,12.6,18.5c0,10.9-8.8,19.7-19.7,19.7H66.2c-9.3,0-16.9-7.6-16.9-16.9C49.3,62.8,49.3,55.8,49.3,55.8z' transform='translate(50, 50) scale(0.8)'/%3E%3Cpath d='M49.3,55.8c-0.2-1.3-0.4-2.6-0.4-3.9c0-11.8,9.6-21.4,21.4-21.4c6.6,0,12.5,3,16.4,7.7c4.6-9.1,14.1-15.3,25-15.3c15.3,0,27.8,12.5,27.8,27.8c0,1.3-0.1,2.5-0.3,3.8c7.4,2.9,12.6,10.1,12.6,18.5c0,10.9-8.8,19.7-19.7,19.7H66.2c-9.3,0-16.9-7.6-16.9-16.9C49.3,62.8,49.3,55.8,49.3,55.8z' transform='translate(350, 120) scale(1.1)'/%3E%3C/g%3E%3C/svg%3E");
            background-size: 400px 400px;
            background-attachment: fixed;
        }

        .toy-card {
            background: white;
            border-radius: 20px;
            border-bottom: 6px solid #cbd5e1;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .input-toy {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            transition: all 0.2s;
        }
        .input-toy:focus {
            outline: none;
            border-color: #1F4788;
            box-shadow: 0 0 0 3px rgba(31, 71, 136, 0.1);
        }

        .btn-toy-primary {
            background-color: #87D336; /* Buzz Green */
            color: white;
            border-bottom: 4px solid #65a328;
            border-radius: 16px;
            transition: all 0.1s;
        }
        .btn-toy-primary:active { transform: translateY(2px); border-bottom-width: 0px; }
        .btn-toy-primary:disabled { background-color: #cbd5e1; border-color: #94a3b8; cursor: not-allowed; }

        .btn-toy-action {
            background-color: #1F4788; /* Toy Blue */
            color: white;
            border-bottom: 4px solid #163260;
            border-radius: 12px;
            transition: all 0.1s;
        }
        .btn-toy-action:active { transform: translateY(2px); border-bottom-width: 0px; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="min-h-screen p-4 pb-20">

    <div class="max-w-4xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="bg-white/90 backdrop-blur rounded-[2rem] shadow-xl border-4 border-white p-4 flex justify-between items-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-toy-red"></div>
            
            <div class="flex items-center gap-4 relative z-10">
                <div class="bg-sky-100 p-2 rounded-full border-2 border-sky-200">
                    <img src="https://res.cloudinary.com/dbeuu3lmv/image/upload/v1768744718/LOGO1_u8zacw.png" 
                         alt="Logo" 
                         class="h-12 w-auto object-contain drop-shadow-md transform hover:rotate-6 transition">
                </div>
                <div>
                    <h1 class="font-cartoon font-bold text-toy-blue text-xl md:text-2xl leading-none">MONEY LOG üí∞</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="group-name-display" class="text-sm font-bold text-gray-400 bg-gray-100 px-2 py-0.5 rounded-md">...</span>
                        <div class="flex items-center gap-1 bg-white border border-gray-200 px-2 py-0.5 rounded-full shadow-sm">
                            <div id="status-dot" class="w-2 h-2 bg-gray-300 rounded-full"></div>
                            <span id="status-text" class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Offline</span>
                        </div>
                    </div>
                </div>
            </div>

            <a href="https://surakit2538.github.io/taiwan2026/" class="btn-toy-action p-3 flex items-center justify-center group" title="‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å">
                <i data-lucide="home" class="group-hover:scale-110 transition-transform"></i>
            </a>
        </header>

        <!-- Permission Error Alert -->
        <div id="error-alert" class="hidden bg-red-100 border-l-8 border-red-500 rounded-xl p-4 shadow-lg animate-bounce">
            <div class="flex items-start gap-3">
                <div class="text-3xl">‚ö†Ô∏è</div>
                <div>
                    <h3 class="font-bold text-red-800 font-cartoon text-lg">Houston, we have a problem!</h3>
                    <p class="text-sm text-red-700 font-medium">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ Firestore Rules (allow read, write: if true;)
                    </p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid md:grid-cols-2 gap-6 items-start">
            
            <!-- Left: Add Form -->
            <div class="toy-card p-6 relative overflow-hidden ring-4 ring-white/50">
                <div class="absolute -right-6 -top-6 bg-toy-yellow w-24 h-24 rounded-full opacity-20 z-0"></div>
                
                <h2 class="text-xl font-cartoon font-bold text-toy-blue flex items-center gap-2 mb-6 relative z-10">
                    <span class="bg-toy-blue text-white p-1.5 rounded-lg text-sm shadow-sm"><i data-lucide="plus-circle" width="18"></i></span>
                    New Expense
                </h2>

                <form id="expense-form" class="space-y-5 relative z-10">
                    <!-- Payer -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 pl-1">Who Paid? ü§†</label>
                        <div id="payer-buttons" class="grid grid-cols-3 gap-2">
                            <!-- JS Generated -->
                        </div>
                        <input type="hidden" id="input-payer">
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Description -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1 pl-1">For What? üè∑Ô∏è</label>
                            <input type="text" id="input-desc" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏¢‡πá‡∏ô, ‡∏Ñ‡πà‡∏≤‡πÅ‡∏ó‡πá‡∏Å‡∏ã‡∏µ‡πà" class="input-toy w-full px-4 py-3 bg-gray-50 text-gray-700 font-medium placeholder-gray-400">
                        </div>

                        <!-- Amount -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1 pl-1">How Much? üíµ</label>
                            <div class="relative">
                                <input type="number" id="input-amount" required min="0" step="0.01" placeholder="0.00" class="input-toy w-full pl-4 pr-12 py-3 bg-gray-50 text-gray-800 font-cartoon text-xl">
                                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-sm">THB</span>
                            </div>
                        </div>
                    </div>

                    <!-- Split Logic -->
                    <div class="bg-sky-50 p-4 rounded-2xl border-2 border-sky-100 border-dashed">
                        <label class="block text-xs font-bold text-toy-blue uppercase tracking-wide mb-3">Split Method üçï</label>
                        
                        <div class="flex bg-white p-1.5 rounded-xl border border-sky-200 mb-3 shadow-sm">
                            <button type="button" id="btn-split-all" class="flex-1 py-2 text-sm rounded-lg transition-all font-bold flex items-center justify-center gap-2 bg-toy-blue text-white shadow-md">
                                All
                            </button>
                            <button type="button" id="btn-split-specific" class="flex-1 py-2 text-sm rounded-lg transition-all font-bold flex items-center justify-center gap-2 text-gray-400 hover:text-toy-blue">
                                Select
                            </button>
                        </div>

                        <div id="specific-split-options" class="hidden space-y-3">
                            <div class="flex justify-between items-center px-1">
                                <span class="text-xs font-bold text-gray-400">For whom?</span>
                                <button type="button" id="btn-select-all" class="text-[10px] font-bold text-toy-blue bg-white px-2 py-1 rounded border border-toy-blue hover:bg-toy-blue hover:text-white transition">Select All</button>
                            </div>
                            <div id="involved-buttons" class="grid grid-cols-2 gap-2">
                                <!-- JS Generated -->
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-toy-primary w-full py-4 font-cartoon text-xl shadow-lg shadow-green-200/50 flex justify-center items-center gap-2">
                        <span>Save Record</span> üöÄ
                    </button>
                </form>
            </div>

            <!-- Right: List -->
            <div class="space-y-4">
                <div class="toy-card p-6 h-[600px] flex flex-col relative ring-4 ring-white/50">
                    <!-- List Header -->
                    <div class="flex justify-between items-center mb-4 pb-4 border-b-2 border-dashed border-gray-100">
                        <h2 class="text-xl font-cartoon font-bold text-toy-blue flex items-center gap-2">
                            <span class="bg-toy-yellow text-toy-blue p-1.5 rounded-lg text-sm shadow-sm"><i data-lucide="list" width="18"></i></span>
                            List (<span id="count-display">0</span>)
                        </h2>
                        <span id="total-badge" class="hidden font-cartoon font-bold text-buzz-green bg-green-50 px-3 py-1 rounded-full border border-green-200 text-sm"></span>
                        
                        <div id="clear-actions" class="ml-auto">
                            <button id="btn-ask-clear" class="text-xs font-bold text-gray-400 hover:text-toy-red bg-gray-50 hover:bg-red-50 px-3 py-1.5 rounded-lg transition-colors">
                                Clear All
                            </button>
                            <div id="confirm-clear" class="hidden flex items-center gap-2 bg-red-50 p-1.5 rounded-lg border border-red-100">
                                <span class="text-xs text-red-600 font-bold">Sure?</span>
                                <button id="btn-confirm-clear" class="bg-toy-red text-white w-6 h-6 rounded flex items-center justify-center shadow-sm"><i data-lucide="check" width="12"></i></button>
                                <button id="btn-cancel-clear" class="bg-white text-gray-500 w-6 h-6 rounded flex items-center justify-center border border-gray-200"><i data-lucide="x" width="12"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Scroll Area -->
                    <div class="flex-1 overflow-y-auto pr-2 relative" id="expenses-scroll-area">
                        <div id="loading-indicator" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 bg-white/80 z-10 hidden">
                            <div class="animate-bounce text-4xl mb-2">üëæ</div>
                            <p class="font-bold text-sm">Loading Data...</p>
                        </div>

                        <div id="empty-state" class="flex flex-col items-center justify-center h-full text-center text-gray-400 hidden">
                            <div class="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mb-4 border-4 border-gray-100">
                                <i data-lucide="clipboard-list" width="40" class="opacity-20"></i>
                            </div>
                            <p class="font-bold text-lg text-gray-300">No Records Yet</p>
                            <p class="text-xs text-gray-300">Start adding expenses!</p>
                        </div>

                        <div id="expenses-container" class="space-y-3 pb-4">
                            <!-- JS Injected -->
                        </div>
                    </div>
                </div>

                <!-- Calculate Button -->
                <button id="btn-calculate" disabled class="w-full bg-toy-blue text-white py-4 rounded-2xl border-b-[6px] border-blue-900 font-cartoon text-xl shadow-xl flex justify-center items-center gap-3 disabled:opacity-50 disabled:border-b-4 disabled:bg-slate-400 disabled:border-slate-500 disabled:cursor-not-allowed transform active:translate-y-1 active:border-b-0 transition-all hover:bg-blue-700">
                    <i data-lucide="calculator" width="24"></i> 
                    <span>CALCULATE</span>
                </button>
            </div>
        </div>

        <!-- Summary Modal/Card -->
        <div id="summary-card" class="hidden bg-white rounded-[2rem] shadow-2xl border-4 border-buzz-green overflow-hidden animate-in fade-in slide-in-from-bottom-10 duration-500 relative ring-8 ring-green-100">
            <!-- Header -->
            <div class="bg-buzz-green p-6 text-white flex justify-between items-center border-b-4 border-green-600 relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-white opacity-20 transform rotate-12">
                    <i data-lucide="coins" width="100" height="100"></i>
                </div>
                <div>
                    <h2 class="font-cartoon text-2xl font-bold shadow-sm">MISSION REPORT</h2>
                    <p class="text-xs font-medium text-green-100 opacity-90">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡∏±‡∏ô</p>
                </div>
                <div class="text-right relative z-10">
                    <span class="block text-xs font-bold text-green-100 uppercase">Total Spent</span>
                    <span id="summary-total" class="font-cartoon text-3xl font-bold drop-shadow-md">0.00</span>
                </div>
            </div>

            <div class="p-6 bg-green-50/50">
                <div id="settlements-container" class="grid md:grid-cols-2 gap-4">
                    <!-- JS Injected -->
                </div>
                
                <div id="settlement-empty" class="hidden text-center py-8">
                    <div class="inline-block p-4 bg-green-100 rounded-full mb-3 text-buzz-green text-4xl animate-bounce">üéâ</div>
                    <p class="font-bold text-buzz-green text-lg">Mission Complete!</p>
                    <p class="text-sm text-gray-500">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏¢‡πâ!</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Global State
        const FIXED_USERS = ['Game', 'Care', 'MAM', 'POP', 'BRIGHT', 'NATTY'];
        const DEFAULT_GROUP_NAME = 'Taiwan2026';
        
        let currentState = {
            user: null,
            expenses: [],
            payer: FIXED_USERS[0],
            splitType: 'all',
            involvedUsers: [...FIXED_USERS],
        };

        const firebaseConfig = {
            apiKey: "AIzaSyAf9VO2hEl0R9re562KfZjcbjTrhNXyofw",
            authDomain: "taiwan2026-663d5.firebaseapp.com",
            projectId: "taiwan2026-663d5",
            storageBucket: "taiwan2026-663d5.firebasestorage.app",
            messagingSenderId: "118390726924",
            appId: "1:118390726924:web:129121eb030c333636a929"
        };
        const appId = "taiwan-trip-data";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const ui = {
            groupName: document.getElementById('group-name-display'),
            statusText: document.getElementById('status-text'),
            statusDot: document.getElementById('status-dot'),
            errorAlert: document.getElementById('error-alert'),
            payerButtons: document.getElementById('payer-buttons'),
            involvedButtons: document.getElementById('involved-buttons'),
            inputPayer: document.getElementById('input-payer'),
            inputDesc: document.getElementById('input-desc'),
            inputAmount: document.getElementById('input-amount'),
            form: document.getElementById('expense-form'),
            btnSplitAll: document.getElementById('btn-split-all'),
            btnSplitSpecific: document.getElementById('btn-split-specific'),
            specificOptions: document.getElementById('specific-split-options'),
            btnSelectAll: document.getElementById('btn-select-all'),
            expensesContainer: document.getElementById('expenses-container'),
            emptyState: document.getElementById('empty-state'),
            loadingIndicator: document.getElementById('loading-indicator'),
            countDisplay: document.getElementById('count-display'),
            totalBadge: document.getElementById('total-badge'),
            btnAskClear: document.getElementById('btn-ask-clear'),
            confirmClear: document.getElementById('confirm-clear'),
            btnConfirmClear: document.getElementById('btn-confirm-clear'),
            btnCancelClear: document.getElementById('btn-cancel-clear'),
            btnCalculate: document.getElementById('btn-calculate'),
            summaryCard: document.getElementById('summary-card'),
            summaryTotal: document.getElementById('summary-total'),
            settlementsContainer: document.getElementById('settlements-container'),
            settlementEmpty: document.getElementById('settlement-empty')
        };

        // Auth
        async function initAuth() {
            try { await signInAnonymously(auth); } 
            catch (error) { console.error("Auth Fail", error); }
        }

        onAuthStateChanged(auth, (user) => {
            currentState.user = user;
            if (user) startSync();
            else ui.statusText.textContent = 'Auth...';
        });

        initAuth();
        ui.groupName.textContent = DEFAULT_GROUP_NAME;
        ui.inputPayer.value = currentState.payer;
        renderPayerButtons();
        renderInvolvedButtons();
        lucide.createIcons();

        // Sync
        function startSync() {
            ui.statusText.textContent = 'Connecting...';
            ui.statusText.classList.remove('text-red-500', 'text-gray-400');
            ui.statusText.classList.add('text-buzz-green');
            ui.statusDot.className = 'w-2 h-2 rounded-full bg-buzz-green animate-pulse';
            
            ui.loadingIndicator.classList.remove('hidden');
            ui.emptyState.classList.add('hidden');
            ui.errorAlert.classList.add('hidden');

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'bill_groups', DEFAULT_GROUP_NAME);

            onSnapshot(docRef, (docSnap) => {
                ui.loadingIndicator.classList.add('hidden');
                ui.statusText.textContent = 'Online';
                
                if (docSnap.exists()) {
                    currentState.expenses = docSnap.data().expenses || [];
                } else {
                    setDoc(docRef, { expenses: [], createdAt: new Date().toISOString() }, { merge: true }).catch(console.error);
                    currentState.expenses = [];
                }
                renderExpenses();
            }, (error) => {
                console.error("Sync Error:", error);
                ui.loadingIndicator.classList.add('hidden');
                ui.statusDot.className = 'w-2 h-2 rounded-full bg-toy-red';
                ui.statusText.textContent = 'Error';
                ui.statusText.classList.add('text-toy-red');
                if (error.code === 'permission-denied') ui.errorAlert.classList.remove('hidden');
            });
        }

        async function saveData(newExpenses) {
            if (!currentState.user) return;
            ui.statusText.textContent = 'Saving...';
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'bill_groups', DEFAULT_GROUP_NAME);
                await updateDoc(docRef, { expenses: newExpenses });
                ui.statusText.textContent = 'Online';
            } catch (e) {
                console.error("Save Error:", e);
                ui.statusText.textContent = 'Failed';
            }
        }

        // Render Functions (Updated for Toy Theme)
        function renderPayerButtons() {
            ui.payerButtons.innerHTML = FIXED_USERS.map(u => `
                <button type="button" class="payer-btn py-2.5 px-1 rounded-xl text-sm font-bold transition-all border-b-4 active:border-b-0 active:translate-y-1 ${
                    currentState.payer === u 
                    ? 'bg-toy-blue text-white border-blue-900 shadow-lg scale-105 z-10' 
                    : 'bg-white text-gray-400 border-gray-200 hover:border-gray-300'
                }" data-user="${u}">
                    ${u}
                </button>
            `).join('');
            
            document.querySelectorAll('.payer-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentState.payer = btn.dataset.user;
                    ui.inputPayer.value = currentState.payer;
                    renderPayerButtons();
                });
            });
        }

        function renderInvolvedButtons() {
            ui.involvedButtons.innerHTML = FIXED_USERS.map(u => {
                const isSelected = currentState.involvedUsers.includes(u);
                return `
                <button type="button" class="involved-btn px-3 py-2 text-xs font-bold rounded-lg border-2 transition-all flex items-center gap-2 ${
                    isSelected
                    ? 'bg-green-50 border-buzz-green text-buzz-green shadow-sm'
                    : 'bg-white border-gray-100 text-gray-300'
                }" data-user="${u}">
                    <div class="w-4 h-4 rounded-full flex items-center justify-center border ${isSelected ? 'bg-buzz-green border-buzz-green text-white' : 'border-gray-200 bg-gray-50'}">
                        ${isSelected ? '<i data-lucide="check" width="10"></i>' : ''}
                    </div>
                    ${u}
                </button>
            `}).join('');
            
            document.querySelectorAll('.involved-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const u = btn.dataset.user;
                    if (currentState.involvedUsers.includes(u)) {
                        if (currentState.involvedUsers.length > 1) currentState.involvedUsers = currentState.involvedUsers.filter(user => user !== u);
                    } else {
                        currentState.involvedUsers.push(u);
                    }
                    renderInvolvedButtons();
                });
            });
            lucide.createIcons();
        }

        function renderExpenses() {
            const expenses = currentState.expenses;
            ui.countDisplay.textContent = expenses.length;
            
            if (expenses.length > 0) {
                const total = expenses.reduce((sum, ex) => sum + ex.amount, 0);
                ui.totalBadge.textContent = `${total.toLocaleString()} ‡∏ø`;
                ui.totalBadge.classList.remove('hidden');
                ui.btnCalculate.disabled = false;
                ui.emptyState.classList.add('hidden');
            } else {
                ui.totalBadge.classList.add('hidden');
                ui.btnCalculate.disabled = true;
                ui.emptyState.classList.remove('hidden');
            }

            // Toy Theme List Items
            ui.expensesContainer.innerHTML = expenses.slice().reverse().map(ex => `
                <div class="group relative bg-white p-4 rounded-2xl border-2 border-gray-100 shadow-sm hover:shadow-md hover:border-sky-200 transition-all">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-full bg-toy-yellow/20 flex items-center justify-center text-toy-yellow border-2 border-toy-yellow/50">
                                <span class="font-bold text-xs">${ex.payer.substring(0,1)}</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-700 leading-tight">${ex.description}</h3>
                                <div class="text-[10px] font-bold text-gray-400 mt-1 uppercase">
                                    Paid by <span class="text-toy-blue">${ex.payer}</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-cartoon text-xl font-bold text-toy-blue">${ex.amount.toLocaleString()}</div>
                            <button class="delete-btn text-gray-300 hover:text-toy-red hover:bg-red-50 p-1.5 rounded-lg transition-colors absolute bottom-2 right-2 opacity-0 group-hover:opacity-100" data-id="${ex.id}">
                                <i data-lucide="trash-2" width="16"></i>
                            </button>
                        </div>
                    </div>
                    <div class="pt-2 border-t border-dashed border-gray-100 flex flex-wrap gap-1 mt-2">
                         ${ex.splitType === 'all' 
                            ? '<span class="text-[10px] font-bold bg-sky-50 text-sky-600 px-2 py-1 rounded-md border border-sky-100">All (6)</span>' 
                            : ex.involved.map(u => `<span class="text-[10px] font-bold bg-gray-50 text-gray-500 px-2 py-1 rounded-md border border-gray-100">${u}</span>`).join('')
                        }
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => removeExpense(Number(e.currentTarget.dataset.id)));
            });
            lucide.createIcons();
        }

        // Logic Listeners
        ui.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const desc = ui.inputDesc.value.trim();
            const amount = parseFloat(ui.inputAmount.value);
            const involved = currentState.splitType === 'all' ? FIXED_USERS : currentState.involvedUsers;

            if (desc && amount && currentState.payer && involved.length > 0) {
                const newExpense = {
                    id: Date.now(), description: desc, amount: amount,
                    payer: currentState.payer, splitType: currentState.splitType,
                    involved: involved, addedBy: currentState.user?.uid.substring(0, 5) || 'anon'
                };
                
                ui.inputDesc.value = ''; ui.inputAmount.value = '';
                currentState.splitType = 'all'; updateSplitTypeUI();
                currentState.involvedUsers = [...FIXED_USERS]; renderInvolvedButtons();
                saveData([...currentState.expenses, newExpense]);
            }
        });

        function removeExpense(id) {
            saveData(currentState.expenses.filter(ex => ex.id !== id));
        }

        // Clear UI Logic
        ui.btnAskClear.addEventListener('click', () => { ui.btnAskClear.parentElement.classList.add('hidden'); ui.confirmClear.classList.remove('hidden'); ui.confirmClear.classList.add('flex'); });
        ui.btnCancelClear.addEventListener('click', () => { ui.confirmClear.classList.add('hidden'); ui.confirmClear.classList.remove('flex'); ui.btnAskClear.parentElement.classList.remove('hidden'); });
        ui.btnConfirmClear.addEventListener('click', () => { 
            ui.confirmClear.classList.add('hidden'); ui.confirmClear.classList.remove('flex'); ui.btnAskClear.parentElement.classList.remove('hidden'); 
            saveData([]); 
        });

        // Split Type Toggle
        function updateSplitTypeUI() {
            if (currentState.splitType === 'all') {
                ui.btnSplitAll.classList.replace('bg-white', 'bg-toy-blue'); ui.btnSplitAll.classList.replace('text-gray-400', 'text-white'); ui.btnSplitAll.classList.add('shadow-md');
                ui.btnSplitSpecific.classList.replace('bg-toy-blue', 'bg-white'); ui.btnSplitSpecific.classList.replace('text-white', 'text-gray-400'); ui.btnSplitSpecific.classList.remove('shadow-md');
                ui.specificOptions.classList.add('hidden');
            } else {
                ui.btnSplitSpecific.classList.replace('bg-white', 'bg-toy-blue'); ui.btnSplitSpecific.classList.replace('text-gray-400', 'text-white'); ui.btnSplitSpecific.classList.add('shadow-md');
                ui.btnSplitAll.classList.replace('bg-toy-blue', 'bg-white'); ui.btnSplitAll.classList.replace('text-white', 'text-gray-400'); ui.btnSplitAll.classList.remove('shadow-md');
                ui.specificOptions.classList.remove('hidden');
            }
        }
        ui.btnSplitAll.addEventListener('click', () => { currentState.splitType = 'all'; updateSplitTypeUI(); });
        ui.btnSplitSpecific.addEventListener('click', () => { currentState.splitType = 'specific'; updateSplitTypeUI(); });
        ui.btnSelectAll.addEventListener('click', () => { currentState.involvedUsers = [...FIXED_USERS]; renderInvolvedButtons(); });

        // Calculate Logic
        ui.btnCalculate.addEventListener('click', () => {
            const expenses = currentState.expenses;
            if (expenses.length === 0) return;

            const totalExpense = expenses.reduce((sum, ex) => sum + ex.amount, 0);
            let balances = {}; FIXED_USERS.forEach(u => balances[u] = 0);

            expenses.forEach(ex => {
                const share = ex.amount / ex.involved.length;
                balances[ex.payer] += ex.amount;
                ex.involved.forEach(user => balances[user] -= share);
            });

            let debtors = [], creditors = [];
            Object.keys(balances).forEach(user => {
                if (balances[user] < -0.01) debtors.push({ user, amount: balances[user] });
                if (balances[user] > 0.01) creditors.push({ user, amount: balances[user] });
            });

            debtors.sort((a, b) => a.amount - b.amount);
            creditors.sort((a, b) => b.amount - a.amount);

            let settlements = [], i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                let amount = Math.min(Math.abs(debtors[i].amount), creditors[j].amount);
                settlements.push({ from: debtors[i].user, to: creditors[j].user, amount });
                debtors[i].amount += amount; creditors[j].amount -= amount;
                if (Math.abs(debtors[i].amount) < 0.01) i++;
                if (creditors[j].amount < 0.01) j++;
            }

            ui.summaryTotal.textContent = `${totalExpense.toLocaleString()} ‡∏ø`;
            ui.summaryCard.classList.remove('hidden');
            
            if (settlements.length === 0) {
                ui.settlementsContainer.innerHTML = ''; ui.settlementEmpty.classList.remove('hidden');
            } else {
                ui.settlementEmpty.classList.add('hidden');
                ui.settlementsContainer.innerHTML = settlements.map(s => `
                    <div class="flex items-center justify-between p-3 bg-white border-2 border-green-100 rounded-xl shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="text-center">
                                <span class="font-bold text-toy-red text-lg block">${s.from}</span>
                            </div>
                            <div class="text-gray-300"><i data-lucide="arrow-right"></i></div>
                            <div class="text-center">
                                <span class="font-bold text-buzz-green text-lg block">${s.to}</span>
                            </div>
                        </div>
                        <span class="font-cartoon font-bold text-gray-700 text-xl">${s.amount.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:0})}</span>
                    </div>
                `).join('');
            }
            ui.summaryCard.scrollIntoView({ behavior: 'smooth' });
        });
    </script>
</body>
</html>
